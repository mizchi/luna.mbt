// Generated by @mizchi/stella
import { Signal, effect } from '@mizchi/luna-wcr';
import * as mod from './counter.mbt.js';

const sheet = new CSSStyleSheet();
sheet.replaceSync(`:host { display: block; font-family: system-ui; } .counter { display: flex; gap: 8px; }`);

class XCounter extends HTMLElement {
  static observedAttributes = ['initial', 'label', 'disabled'];

  #props = {
    initial: new Signal(0),
    label: new Signal('Count'),
    disabled: new Signal(false),
  };
  #dispose = null;
  #connected = false;

  connectedCallback() {
    this.#connected = true;
    this.#syncAttributes();

    const shadow = this.shadowRoot ?? this.attachShadow({ mode: 'open' });
    shadow.adoptedStyleSheets = [sheet];

    if (!this.shadowRoot && mod.template) {
      shadow.innerHTML = mod.template(this.#getSnapshot());
    }

    this.#dispose = mod.setup({
      element: this,
      shadow,
      props: this.#props,
    });
  }

  disconnectedCallback() {
    this.#connected = false;
    this.#dispose?.();
    this.#dispose = null;
  }

  attributeChangedCallback(name, _, newVal) {
    if (!this.#connected) return;
    switch (name) {
      case 'initial':
        this.#props.initial.set(parseInt(newVal ?? '0', 10));
        break;
      case 'label':
        this.#props.label.set(newVal ?? '');
        break;
      case 'disabled':
        this.#props.disabled.set(newVal !== null);
        break;
    }
  }

  #syncAttributes() {
    this.#props.initial.set(parseInt(this.getAttribute('initial') ?? '0', 10));
    this.#props.label.set(this.getAttribute('label') ?? 'Count');
    this.#props.disabled.set(this.hasAttribute('disabled'));
  }

  #getSnapshot() {
    return {
      initial: this.#props.initial.get(),
      label: this.#props.label.get(),
      disabled: this.#props.disabled.get(),
    };
  }
}

customElements.define('x-counter', XCounter);
