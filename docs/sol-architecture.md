# Sol Framework Architecture

Sol フレームワークのディレクトリ構造とビルドフローを定義する。

## ディレクトリ構造

```
myproject/
├── app/                      # ソースコード (moon.mod.json の source)
│   ├── _gen/                 # 生成された MoonBit コード (.gitignore)
│   │   ├── client/           # クライアント用エクスポート
│   │   │   ├── exports.mbt   # islands + components の re-export
│   │   │   └── moon.pkg.json
│   │   └── server/           # サーバー用エクスポート
│   │       ├── exports.mbt   # pages + components の re-export
│   │       └── moon.pkg.json
│   ├── client/               # クライアント側コード
│   │   ├── components/       # 共有コンポーネント (SSR + Client)
│   │   │   ├── counter.mbt
│   │   │   └── moon.pkg.json
│   │   ├── hydrate.mbt       # Hydration エントリ
│   │   └── moon.pkg.json
│   └── server/               # サーバー側コード
│       ├── pages/            # ページコンポーネント (各ページは独立パッケージ)
│       │   ├── home/
│       │   │   ├── home.mbt
│       │   │   └── moon.pkg.json
│       │   └── about/
│       │       ├── about.mbt
│       │       └── moon.pkg.json
│       └── run/              # サーバーエントリポイント
│           ├── main.mbt      # main 関数、ルート設定
│           └── moon.pkg.json
├── .sol/                     # 生成された JS アセット (.gitignore)
│   └── luna-client-entry.js  # Luna loader 互換クライアントエントリ
├── static/                   # 静的ファイル (rolldown 出力先)
│   ├── client.js             # バンドル済みクライアント JS
│   └── loader.min.js         # Luna loader スクリプト
├── .gitignore
├── moon.mod.json
├── package.json
├── rolldown.config.mjs       # rolldown 設定
└── sol.config.json           # sol generate 設定
```

## 設定ファイル

### sol.config.json

`sol generate` コマンドで使用する設定ファイル。

```json
{
  "components": ["app/client/components/*"],
  "islands": ["app/client"],
  "pages": ["app/server/pages/*"],
  "output": "app/_gen"
}
```

| フィールド | 説明 |
|-----------|------|
| `components` | SSR コンポーネントのディレクトリ（glob パターン） |
| `islands` | Islands（クライアントハイドレーション）のディレクトリ |
| `pages` | ページコンポーネントのディレクトリ |
| `output` | MoonBit 生成コードの出力先 |

### rolldown.config.mjs

```javascript
import { defineConfig } from 'rolldown';

export default defineConfig({
  input: {
    client: './.sol/luna-client-entry.js',
  },
  output: {
    dir: './static',
    format: 'esm',
    entryFileNames: '[name].js',
  },
});
```

## ビルドフロー

`sol build` は以下の順序でビルドを実行する：

### 1. moon info (mbti 生成)

```bash
moon info --target js
```

`app/` 以下の各パッケージに `pkg.generated.mbti` を生成する。
これにより各パッケージの公開 API（`pub fn`）が抽出可能になる。

### 2. sol generate (エクスポート生成)

`sol.config.json` を読み込み、以下を生成：

**MoonBit コード (`app/_gen/`):**
- `client/exports.mbt` - islands + components の re-export
- `client/moon.pkg.json` - `link.js.exports` でクライアント用エクスポート
- `server/exports.mbt` - pages + components の re-export
- `server/moon.pkg.json` - `link.js.exports` でサーバー用エクスポート

**JS コード (`.sol/`):**
- `luna-client-entry.js` - Luna loader 互換のクライアントエントリポイント

### 3. moon build (MoonBit コンパイル)

```bash
moon build --target js
```

`app/_gen/` を含む全パッケージをコンパイル。
- `target/js/release/build/_gen/client/exports.js` - クライアント用
- `target/js/release/build/_gen/server/exports.js` - サーバー用
- `target/js/release/build/server/run/run.js` - サーバーエントリ

### 4. rolldown (バンドル)

```bash
npx rolldown -c rolldown.config.mjs
```

`.sol/luna-client-entry.js` をエントリポイントとして `static/client.js` を生成。
Tree-shaking により使用されていないコードは削除される。

## この構造を採用する理由

### なぜ `app/_gen/` が必要か

MoonBit は `moon.mod.json` の `source` で指定したディレクトリ以下しかコンパイル対象にならない。
生成した MoonBit コードをビルドに含めるため、`app/` 以下に `_gen/` を配置する。

### なぜ re-export が必要か

MoonBit が JS を生成すると、各パッケージごとに内部ランタイムが重複してしまう。
全ての API を一つの `exports.mbt` で re-export することで：

1. 単一の ESM モジュールとして出力される
2. rolldown で tree-shake 可能になる
3. chunk 分割でコード共有が最適化される

### なぜ `.sol/` が別か

生成された JS アセットは MoonBit のビルド対象外。
プロジェクトルートの `.sol/` に配置することで：

1. `app/` の MoonBit コードと分離
2. rolldown のエントリポイントとして使いやすい
3. `.gitignore` で管理しやすい

### なぜページが独立パッケージか

各ページを `pages/home/`, `pages/about/` のように独立パッケージにすることで：

1. ページ間で同名の関数（`page`）を定義できる
2. 各ページの依存関係を明確に管理できる
3. 使用しないインポートによる警告を回避できる

## 生成されるファイル例

### app/_gen/client/exports.mbt

```moonbit
///| Auto-generated - Client exports
///| Generated by: sol generate

// ============================================
// Islands (Hydration)
// ============================================

///|
pub fn island_client_hydrate_counter(
  p0 : @core.Any,
  p1 : @core.Any,
  p2 : String
) -> Unit {
  @client.hydrate_counter(p0, p1, p2)
}
```

### app/_gen/server/exports.mbt

```moonbit
///| Auto-generated - Server exports
///| Generated by: sol generate

// ============================================
// Components
// ============================================

///|
pub fn components_render(p0 : @signal.Signal[Int]) -> @luna.Node[Unit] {
  @components.render(p0)
}
```

### .sol/luna-client-entry.js

```javascript
// Luna loader compatible client entry
// Generated by: sol generate

import * as exports from '../target/js/release/build/_gen/client/client.js';

export const hydrate_counter = exports.island_client_hydrate_counter;

export default hydrate_counter;
```

Luna loader は `ln:export` 属性で指定されたエクスポート名（例: `hydrate_counter`）を
このモジュールから動的にインポートしてハイドレーションを実行する。

## ハイドレーションフロー

1. サーバーが HTML をレンダリング（`ln:*` 属性付き）
2. ブラウザが `loader.min.js` を実行
3. `[ln:id]` 要素を検出
4. `ln:url` から JS モジュールをインポート
5. `ln:export` で指定された関数を呼び出し
6. `ln:state` の状態を復元してハイドレーション完了

### ln:* 属性

| 属性 | 説明 |
|------|------|
| `ln:id` | Island の一意識別子 |
| `ln:url` | Hydration 用モジュールの URL |
| `ln:export` | モジュールからエクスポートする関数名 |
| `ln:trigger` | ハイドレーションのタイミング（load, idle, visible, media） |
| `ln:state` | シリアライズされた状態 JSON |

## CLI コマンド

### sol new

新規プロジェクトを作成する。

```bash
sol new <name> --user <namespace> [--dev]
```

| オプション | 説明 |
|-----------|------|
| `--user`, `-u` | ユーザー/組織の名前空間（必須） |
| `--dev`, `-d` | 開発モード（ローカル luna パスを使用） |

### sol generate

`sol.config.json` に基づいてコード生成を実行。

```bash
sol generate
```

### sol build

フルビルドを実行（info → generate → build → rolldown）。

```bash
sol build
```
