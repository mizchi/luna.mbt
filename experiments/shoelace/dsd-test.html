<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Declarative Shadow DOM Test for CLS Prevention</title>

  <!-- Shoelace CSS - Critical for CLS prevention -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />

  <style>
    body {
      font-family: var(--sl-font-sans);
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .section {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    h2 { margin-top: 0; }

    /* CLS Prevention: Reserve space for undefined elements */
    sl-button:not(:defined) {
      display: inline-block;
      min-height: 40px;
      min-width: 80px;
    }

    sl-input:not(:defined) {
      display: block;
      min-height: 56px;
    }

    sl-card:not(:defined) {
      display: block;
      min-height: 200px;
    }

    /* Measure CLS */
    .cls-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 0.5rem 1rem;
      background: #333;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="cls-indicator">CLS: <span id="cls-value">measuring...</span></div>

  <h1>Declarative Shadow DOM Test</h1>
  <p>CLS（Cumulative Layout Shift）を防ぐためのDSD検証</p>

  <!-- Approach 1: Standard Shoelace (baseline) -->
  <div class="section">
    <h2>1. Standard Shoelace (CLS発生の可能性あり)</h2>
    <p>通常のShoelaceコンポーネント。JSロード後にShadow DOM構築。</p>

    <sl-button variant="primary">Standard Button</sl-button>
    <br><br>
    <sl-input label="Standard Input" placeholder="Type here"></sl-input>
  </div>

  <!-- Approach 2: Pre-sized with CSS (CLS軽減) -->
  <div class="section">
    <h2>2. CSS Pre-sizing (CLS軽減)</h2>
    <p>:not(:defined)でサイズを予約。ある程度CLSを防げる。</p>

    <sl-button variant="success" style="--sl-button-height: 40px;">Pre-sized Button</sl-button>
    <br><br>
    <sl-input label="Pre-sized Input" style="min-height: 56px;"></sl-input>
  </div>

  <!-- Approach 3: Skeleton Placeholder -->
  <div class="section">
    <h2>3. Skeleton Placeholder (CLS防止)</h2>
    <p>JSロード前はスケルトンを表示、ロード後に置換。</p>

    <div id="skeleton-container">
      <!-- Skeleton shown before JS loads -->
      <div class="skeleton-button" style="
        display: inline-block;
        width: 120px;
        height: 40px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
      "></div>
    </div>

    <style>
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
    </style>
  </div>

  <!-- Approach 4: Declarative Shadow DOM Simulation -->
  <div class="section">
    <h2>4. Declarative Shadow DOM (理想的なCLS防止)</h2>
    <p>SSR時にShadow DOMの内容をHTMLに含める。</p>

    <!--
      Note: Shoelaceのコンポーネントは内部でLitを使用しており、
      Lit SSRを使えばDSDでレンダリング可能。
      以下はDSDの概念を示す例。
    -->

    <!-- Custom element with DSD -->
    <my-button>
      <template shadowrootmode="open">
        <style>
          :host {
            display: inline-block;
          }
          button {
            background: var(--sl-color-primary-600, #0ea5e9);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            min-height: 40px;
          }
          button:hover {
            background: var(--sl-color-primary-700, #0284c7);
          }
        </style>
        <button><slot></slot></button>
      </template>
      DSD Button
    </my-button>

    <br><br>

    <!-- DSD input simulation -->
    <my-input>
      <template shadowrootmode="open">
        <style>
          :host {
            display: block;
          }
          .wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
          }
          label {
            font-size: 14px;
            color: #333;
          }
          input {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-height: 40px;
          }
        </style>
        <div class="wrapper">
          <label>DSD Input</label>
          <input type="text" placeholder="Type here">
        </div>
      </template>
    </my-input>
  </div>

  <!-- Approach 5: contain-intrinsic-size -->
  <div class="section">
    <h2>5. contain-intrinsic-size (モダンCLS対策)</h2>
    <p>content-visibility: auto と組み合わせてサイズを予約。</p>

    <div style="content-visibility: auto; contain-intrinsic-size: 0 40px;">
      <sl-button variant="warning">Contained Button</sl-button>
    </div>
  </div>

  <!-- CLS Measurement Script -->
  <script>
    // Measure CLS using Performance Observer
    let clsValue = 0;
    const clsDisplay = document.getElementById('cls-value');

    if ('PerformanceObserver' in window) {
      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput) {
            clsValue += entry.value;
            clsDisplay.textContent = clsValue.toFixed(4);

            if (clsValue > 0.1) {
              clsDisplay.style.color = '#ff6b6b';
            } else if (clsValue > 0.05) {
              clsDisplay.style.color = '#ffd93d';
            } else {
              clsDisplay.style.color = '#6bcb77';
            }
          }
        }
      });

      observer.observe({ type: 'layout-shift', buffered: true });
    } else {
      clsDisplay.textContent = 'Not supported';
    }

    // Log when components are defined
    const logDefinition = (name) => {
      customElements.whenDefined(name).then(() => {
        console.log(`${name} defined at ${performance.now().toFixed(2)}ms`);
      });
    };

    logDefinition('sl-button');
    logDefinition('sl-input');
  </script>

  <!-- Shoelace JS - loaded late to simulate slow network -->
  <script type="module">
    // Artificial delay to demonstrate CLS
    // await new Promise(r => setTimeout(r, 1000));

    import 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js';

    // Replace skeleton with actual component
    await customElements.whenDefined('sl-button');

    const skeletonContainer = document.getElementById('skeleton-container');
    skeletonContainer.innerHTML = '<sl-button variant="danger">Replaced Button</sl-button>';
  </script>
</body>
</html>
