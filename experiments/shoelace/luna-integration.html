<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luna + Shoelace Integration Prototype</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />

  <style>
    :not(:defined) { visibility: hidden; }

    body {
      font-family: var(--sl-font-sans);
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .section {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid var(--sl-color-neutral-200);
      border-radius: var(--sl-border-radius-medium);
    }

    h2 { margin-top: 0; color: var(--sl-color-primary-600); }
    pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    code { font-family: monospace; }
  </style>
</head>
<body>
  <h1>Luna + Shoelace Integration Prototype</h1>

  <p>
    このページはLunaのシグナルシステムとShoelaceコンポーネントの統合をプロトタイピングします。
    実際のLunaコードで使う前に、JavaScriptでパターンを検証します。
  </p>

  <!-- Prototype 1: Signal-driven Shoelace -->
  <div class="section">
    <h2>1. Signal-driven Components</h2>
    <p>LunaのSignalパターンでShoelaceを制御</p>

    <div id="signal-demo"></div>

    <pre><code>// Luna equivalent (conceptual)
let count = Signal::new(0)
let name = Signal::new("")

sl_button(
  variant="primary",
  on_click=fn() { count.update(fn(n) { n + 1 }) },
  [text_sig(count.map(fn(n) { "Count: \{n}" }))]
)

sl_input(
  label="Name",
  value=name,
  on_input=fn(e) { name.set(e.target.value) }
)</code></pre>
  </div>

  <!-- Prototype 2: Reactive Form -->
  <div class="section">
    <h2>2. Reactive Form</h2>
    <p>フォームの状態管理</p>

    <div id="form-demo"></div>

    <pre><code>// Luna equivalent (conceptual)
let form = Store::new({
  email: "",
  password: "",
  remember: false,
  valid: false
})

// Derived validation
let is_valid = memo(fn() {
  form.get().email.contains("@") &&
  form.get().password.length() >= 8
})</code></pre>
  </div>

  <!-- Prototype 3: Dialog with State -->
  <div class="section">
    <h2>3. Dialog with State</h2>
    <p>ダイアログの開閉状態をSignalで管理</p>

    <div id="dialog-demo"></div>

    <pre><code>// Luna equivalent (conceptual)
let dialog_open = Signal::new(false)

sl_button(
  on_click=fn() { dialog_open.set(true) },
  ["Open Dialog"]
)

sl_dialog(
  open=dialog_open,
  label="Confirm Action",
  [
    text("Are you sure?"),
    sl_button(
      slot="footer",
      variant="primary",
      on_click=fn() { dialog_open.set(false) },
      ["Confirm"]
    )
  ]
)</code></pre>
  </div>

  <!-- Prototype 4: List Rendering -->
  <div class="section">
    <h2>4. Dynamic List</h2>
    <p>リストのリアクティブレンダリング</p>

    <div id="list-demo"></div>

    <pre><code>// Luna equivalent (conceptual)
let items = Signal::new(["Apple", "Banana", "Cherry"])

for_each(items, fn(item, index) {
  sl_tag(
    variant="primary",
    removable=true,
    on_remove=fn() {
      items.update(fn(list) {
        list.filter(fn(_, i) { i != index })
      })
    },
    [text(item)]
  )
})</code></pre>
  </div>

  <script type="module">
    import 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js';

    // Wait for components
    await Promise.all([
      customElements.whenDefined('sl-button'),
      customElements.whenDefined('sl-input'),
      customElements.whenDefined('sl-dialog'),
      customElements.whenDefined('sl-tag'),
      customElements.whenDefined('sl-checkbox'),
    ]);

    // ============================================================
    // Simple Signal Implementation (mimics Luna's Signal)
    // ============================================================
    class Signal {
      constructor(initialValue) {
        this._value = initialValue;
        this._subscribers = [];
      }

      get() {
        return this._value;
      }

      set(newValue) {
        if (this._value !== newValue) {
          this._value = newValue;
          this._notify();
        }
      }

      update(fn) {
        this.set(fn(this._value));
      }

      subscribe(fn) {
        this._subscribers.push(fn);
        return () => {
          this._subscribers = this._subscribers.filter(s => s !== fn);
        };
      }

      _notify() {
        this._subscribers.forEach(fn => fn(this._value));
      }

      map(fn) {
        const derived = new Signal(fn(this._value));
        this.subscribe(v => derived.set(fn(v)));
        return derived;
      }
    }

    // ============================================================
    // Demo 1: Signal-driven Components
    // ============================================================
    {
      const container = document.getElementById('signal-demo');
      const count = new Signal(0);
      const name = new Signal('');

      // Create button
      const button = document.createElement('sl-button');
      button.variant = 'primary';
      button.textContent = 'Count: 0';
      button.addEventListener('click', () => count.update(n => n + 1));

      // React to count changes
      count.subscribe(n => {
        button.textContent = `Count: ${n}`;
      });

      // Create input
      const input = document.createElement('sl-input');
      input.label = 'Your Name';
      input.placeholder = 'Enter your name';
      input.addEventListener('sl-input', e => name.set(e.target.value));

      // Create greeting
      const greeting = document.createElement('p');
      greeting.textContent = 'Hello, stranger!';
      name.subscribe(n => {
        greeting.textContent = n ? `Hello, ${n}!` : 'Hello, stranger!';
      });

      container.appendChild(button);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      container.appendChild(input);
      container.appendChild(greeting);
    }

    // ============================================================
    // Demo 2: Reactive Form
    // ============================================================
    {
      const container = document.getElementById('form-demo');
      const email = new Signal('');
      const password = new Signal('');
      const remember = new Signal(false);

      // Derived validation state
      const isValid = new Signal(false);
      const updateValid = () => {
        const emailOk = email.get().includes('@');
        const passOk = password.get().length >= 8;
        isValid.set(emailOk && passOk);
      };
      email.subscribe(updateValid);
      password.subscribe(updateValid);

      // Email input
      const emailInput = document.createElement('sl-input');
      emailInput.type = 'email';
      emailInput.label = 'Email';
      emailInput.placeholder = 'you@example.com';
      emailInput.addEventListener('sl-input', e => email.set(e.target.value));

      // Password input
      const passInput = document.createElement('sl-input');
      passInput.type = 'password';
      passInput.label = 'Password';
      passInput.placeholder = 'At least 8 characters';
      passInput.style.marginTop = '1rem';
      passInput.addEventListener('sl-input', e => password.set(e.target.value));

      // Remember checkbox
      const rememberBox = document.createElement('sl-checkbox');
      rememberBox.textContent = 'Remember me';
      rememberBox.style.display = 'block';
      rememberBox.style.marginTop = '1rem';
      rememberBox.addEventListener('sl-change', e => remember.set(e.target.checked));

      // Submit button
      const submitBtn = document.createElement('sl-button');
      submitBtn.variant = 'primary';
      submitBtn.textContent = 'Login';
      submitBtn.disabled = true;
      submitBtn.style.marginTop = '1rem';

      isValid.subscribe(valid => {
        submitBtn.disabled = !valid;
      });

      submitBtn.addEventListener('click', () => {
        alert(`Login: ${email.get()}, Remember: ${remember.get()}`);
      });

      // Status
      const status = document.createElement('p');
      status.innerHTML = '<small>Email must contain @ and password must be 8+ characters</small>';

      container.appendChild(emailInput);
      container.appendChild(passInput);
      container.appendChild(rememberBox);
      container.appendChild(submitBtn);
      container.appendChild(status);
    }

    // ============================================================
    // Demo 3: Dialog with State
    // ============================================================
    {
      const container = document.getElementById('dialog-demo');
      const dialogOpen = new Signal(false);

      // Open button
      const openBtn = document.createElement('sl-button');
      openBtn.variant = 'primary';
      openBtn.textContent = 'Open Dialog';
      openBtn.addEventListener('click', () => dialogOpen.set(true));

      // Dialog
      const dialog = document.createElement('sl-dialog');
      dialog.label = 'Confirm Action';
      dialog.innerHTML = `
        <p>Are you sure you want to proceed?</p>
        <sl-button slot="footer" variant="default" class="cancel-btn">Cancel</sl-button>
        <sl-button slot="footer" variant="primary" class="confirm-btn">Confirm</sl-button>
      `;

      dialog.querySelector('.cancel-btn').addEventListener('click', () => dialogOpen.set(false));
      dialog.querySelector('.confirm-btn').addEventListener('click', () => {
        alert('Confirmed!');
        dialogOpen.set(false);
      });

      // Sync dialog state
      dialogOpen.subscribe(open => {
        if (open) dialog.show();
        else dialog.hide();
      });

      container.appendChild(openBtn);
      container.appendChild(dialog);
    }

    // ============================================================
    // Demo 4: Dynamic List
    // ============================================================
    {
      const container = document.getElementById('list-demo');
      const items = new Signal(['Apple', 'Banana', 'Cherry', 'Date']);

      const listContainer = document.createElement('div');
      listContainer.style.display = 'flex';
      listContainer.style.gap = '0.5rem';
      listContainer.style.flexWrap = 'wrap';
      listContainer.style.marginBottom = '1rem';

      const renderList = () => {
        listContainer.innerHTML = '';
        items.get().forEach((item, index) => {
          const tag = document.createElement('sl-tag');
          tag.variant = 'primary';
          tag.removable = true;
          tag.textContent = item;
          tag.addEventListener('sl-remove', () => {
            items.update(list => list.filter((_, i) => i !== index));
          });
          listContainer.appendChild(tag);
        });
      };

      items.subscribe(renderList);
      renderList();

      // Add item input
      const addContainer = document.createElement('div');
      addContainer.style.display = 'flex';
      addContainer.style.gap = '0.5rem';

      const addInput = document.createElement('sl-input');
      addInput.placeholder = 'New item';
      addInput.size = 'small';

      const addBtn = document.createElement('sl-button');
      addBtn.variant = 'success';
      addBtn.size = 'small';
      addBtn.textContent = 'Add';
      addBtn.addEventListener('click', () => {
        const value = addInput.value.trim();
        if (value) {
          items.update(list => [...list, value]);
          addInput.value = '';
        }
      });

      addContainer.appendChild(addInput);
      addContainer.appendChild(addBtn);

      container.appendChild(listContainer);
      container.appendChild(addContainer);
    }

    console.log('Luna + Shoelace integration prototype loaded');
  </script>
</body>
</html>
